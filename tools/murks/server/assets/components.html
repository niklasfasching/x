{{ define "<btn-login>" }}
  <template>
    {{ if api.IsDev }}
      <form method="post" action="/login" class="stack gap-2">
        <input type="hidden" name="code" value="{{ api.DevLoginCode }}">
        <button id="login-enter" class="btn primary w-full">Enter (dev)</button>
      </form>
    {{ else }}
      <a class="btn primary w-full text-center" href="https://t.me/{{ api.TelegramBotName }}?start=login">Login via Telegram</a>
    {{ end }}
  </template>
{{ end }}


{{ define "<entry-own>" }}
  <template>
    <div class="entry stack gap-3 p-3 border rounded bg-white shadow-sm {{if eq .app.Status 0}}bg-warn-dim{{end}}{{if eq .app.Status 1}} under-construction{{end}}">
      {{ if ne .app.Status 0 }}
        <div class="cluster between">
          <a href="{{api.URL .app.Slug}}" class="cluster entry-link">
            <div class="frame icon rounded border bg-white p-1">
              <img src="{{api.URL .app.Slug}}/assets/icon.svg" loading="lazy" alt="">
            </div>
            <div class="stack gap-1" style="min-width: 0;">
              <b class="text-sm ellipsis">{{.app.Name}}</b>
              <span class="mono text-xs text-gray">{{ .app.Slug }}.{{api.Domain}}</span>
              {{ if and (not .app.IsPublic) .app.Users }}
                <span class="mono text-xs text-gray">shared with {{ range $i, $u := .app.Users }}{{ if $i }}, {{ end }}@{{ $u }}{{ end }}</span>
              {{ end }}
            </div>
          </a>

          <div class="cluster gap-1">
            <button onclick="togglePublic('{{api.URL .app.Slug}}')"
                    class="toggle {{if not .app.IsPublic}}active bg-blue-dim{{end}}"
                    title="{{if .app.IsPublic}}Make Private{{else}}Make Public{{end}}">
              <publish-status-icon app={{ .app }} />
            </button>
            <button onclick="toggleStatus('{{api.URL .app.Slug}}', {{.app.Status}})"
                    class="toggle active {{if eq .app.Status 2}}ok{{else}}warn{{end}}"
                    title="{{if ne .app.Status 2}}Under Construction - Click to enable data protection{{else}}Live - Click to enable construction mode{{end}}">
              {{if ne .app.Status 2}}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
              {{else}}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="5"/></svg>
              {{end}}
            </button>
            <button onclick="openOptions({id: '{{.app.ID}}', slug: '{{.app.Slug}}', name: '{{.app.Name}}', url: '{{api.URL .app.Slug}}', chatUrl: '{{.app.ChatURL}}', pub: {{.app.IsPublic}}}, 'owner')" class="btn ghost" title="Options">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
            </button>
          </div>
        </div>
      {{ else }}
        <div class="cluster between">
          <a href="{{api.URL .app.Slug}}" class="cluster entry-link">
            <div class="frame icon rounded border bg-white p-1">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
            </div>
            <div class="stack gap-1" style="min-width: 0;">
              <b class="text-sm ellipsis">{{.app.Name}}</b>
              <span class="mono text-xs text-gray">{{ .app.Slug }}.{{api.Domain}}</span>
            </div>
          </a>
          <div class="cluster gap-1">
            <button disabled class="toggle active warn" title="Not deployed yet">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </button>
            <button onclick="deleteApp('{{api.URL .app.Slug}}')" class="btn ghost err" title="Delete App">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </div>
        </div>

        <div class="stack gap-3 p-3 rounded border bg-white shadow-sm">
          <div class="cluster gap-2 text-sm bold text-gray">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            Option 1: Build a new App
          </div>
          <div class="text-sm text-gray" style="line-height: 1.6;">
            1. Copy the message and paste it into a <b>Gemini Chat</b><br>
            2. Describe your app<br>
            3. Open the Canvas and your app will be live at
            <a href="{{api.URL .app.Slug}}">{{.app.Slug}}.{{api.Domain}}</a>
          </div>
          <div class="stack gap-2">
            <button onclick="copyPrompt('{{.app.ID}}', '{{.app.Name}}', '', 'Copied!')"
                    class="btn primary w-full justify-center" title="Copy Message">
              Copy Message
            </button>
            <button onclick="window.open('https://gemini.google.com/', '_blank')" class="btn secondary w-full justify-center">
              Open Gemini & Paste
            </button>
          </div>
          <div class="border-b" style="opacity: 0.5;"></div>
          <div class="stack gap-2">
            <div class="cluster gap-2 text-sm bold text-gray">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11l2 2-2 2"></path><path d="M8 13h6"></path></svg>
              Option 2: Remix an existing App
            </div>
            <div class="text-sm text-gray">Paste the apps subdomain or url here to copy it.</div>
            <form onsubmit="event.preventDefault(); remixInto('{{.app.ID}}', this.src.value)" class="cluster gap-2">
              <input type="text" name="src" required
                     placeholder="e.g. example"
                     class="input" style="flex: 1;">
              <button type="submit" class="btn secondary">Remix</button>
            </form>
          </div>
        </div>
      {{ end }}
    </div>
  </template>
{{ end }}


{{ define "<entry-shared>" }}
  <template>
    <div class="cluster between p-3 border-b">
      <a href="{{api.URL .app.Slug}}" class="cluster entry-link">
        <div class="frame icon rounded border bg-white p-1">
          <img src="{{api.URL .app.Slug}}/assets/icon.svg" loading="lazy" alt="">
        </div>
        <div class="stack gap-1" style="min-width: 0;">
          <b class="text-sm ellipsis">{{.app.Name}} <span class="text-gray" style="font-weight: normal;">@{{.app.Owner}}</span></b>
          <span class="mono text-xs text-gray">Community App</span>
        </div>
      </a>
      <div class="cluster gap-1">
        <button disabled class="toggle {{if not .app.IsPublic}}active bg-blue-dim{{end}}">
          <publish-status-icon app={{ .app }} />
        </button>
        <button onclick="copyHTML('{{api.URL .app.Slug}}')" class="btn ghost" title="Copy HTML">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
        <button onclick="deleteApp('{{api.URL .app.Slug}}')" class="btn ghost err" title="Remove">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </button>
      </div>
    </div>
  </template>
{{ end }}


{{ define "<entry-maintainer>" }}
  <template>
    <div class="entry stack gap-3 p-3 border rounded bg-white shadow-sm">
      <div class="cluster between">
        <a href="{{api.URL .app.Slug}}" class="cluster entry-link">
          <div class="frame icon rounded border bg-white p-1">
            <img src="{{api.URL .app.Slug}}/assets/icon.svg" loading="lazy" alt="">
          </div>
          <div class="stack gap-1" style="min-width: 0;">
            <b class="text-sm ellipsis">{{.app.Name}} <span class="text-gray" style="font-weight: normal;">@{{.app.Owner}}</span></b>
            <span class="mono text-xs text-gray">{{ .app.Slug }}.{{api.Domain}}</span>
          </div>
        </a>

        <div class="cluster gap-1">
          <button onclick="openOptions({id: '{{.app.ID}}', slug: '{{.app.Slug}}', name: '{{.app.Name}}', url: '{{api.URL .app.Slug}}', chatUrl: '{{.app.ChatURL}}', pub: {{.app.IsPublic}}, owner: '{{.app.Owner}}'}, 'maintainer')" class="btn ghost" title="Options">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
          </button>
        </div>
      </div>
    </div>
  </template>
{{ end }}


{{ define "<app-options>" }}
  <style>
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 20px 20px 0 0;
      box-shadow: var(--sh-up);
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      z-index: 1000;
      max-width: 600px;
      margin: 0 auto;
      padding-bottom: env(safe-area-inset-bottom);
      max-height: 90dvh;
      overflow-y: auto;
      overscroll-behavior: contain;
      &.open {
        transform: translateY(0);
        visibility: visible;
      }
    }
    .sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 999;
      backdrop-filter: blur(2px);
      &.open {
        opacity: 1;
        pointer-events: auto;
      }
    }
    .sheet-handle {
      width: 40px;
      height: 5px;
      background: var(--c-border);
      border-radius: 10px;
      margin: 12px auto;
    }
    .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      text-align: left;
      font-size: 0.95rem;
      color: var(--c-text);
      border-radius: 8px;
      &:hover { background: var(--c-gray-light); }
      & svg {
        width: 18px;
        height: 18px;
        opacity: 0.6;
      }
      &.danger {
        color: var(--c-err);
        & svg {
          opacity: 1;
          color: var(--c-err);
        }
      }
    }
    .bottom-sheet [data-for] { display: none; }
    .bottom-sheet[data-role="owner"] [data-for~="owner"],
    .bottom-sheet[data-role="maintainer"] [data-for~="maintainer"] { display: flex; }
  </style>
  <script>
  function openOptions(app, role) {
    window._CURRENT_APP = app;
    const sheet = document.getElementById('app-sheet');
    sheet.dataset.role = role;
    sheet.querySelector('[data-section="gemini"]').hidden = (role === 'maintainer');
    sheet.querySelector('[data-section="github"]').hidden = (role !== 'maintainer');
    if (role === 'maintainer') sheet.querySelector('[data-section="github"] a').href =
      `https://github.com/{{api.DeployRepo}}/issues/new?title=[${encodeURIComponent(app.slug)}]`;
    sheet.querySelector('[data-action="chat-existing"]').hidden = !app.chatUrl;
    sheet.querySelector('[data-action="chat-missing"]').hidden = !!app.chatUrl;
    sheet.querySelector('[data-action="invite"]').hidden = (role === 'owner' && !app.pub);
    sheet.classList.add('open');
    document.getElementById('sheet-overlay').classList.add('open');
  }
  function closeOptions() {
    document.getElementById('app-sheet').classList.remove('open');
    document.getElementById('sheet-overlay').classList.remove('open');
  }
  async function renameApp() {
    const a = window._CURRENT_APP;
    const msg = `Enter the new link for "[${a.slug}].{{api.Domain}}":`;
    const s = prompt(msg, a.slug);
    if (!s || s === a.slug) return;
    await api(`${a.url}/api/update?slug=${encodeURIComponent(s)}`);
    location.reload();
  }
  async function renameAppName() {
    const a = window._CURRENT_APP;
    const s = prompt(`Enter new name for "${a.name}":`, a.name);
    if (!s || s === a.name) return;
    await api(`${a.url}/api/update?name=${encodeURIComponent(s)}`);
    location.reload();
  }
  async function toggleGitHub() {
    const a = window._CURRENT_APP;
    if (!confirm('Deploy to GitHub? This will transfer ownership to the deploy repo.')) return;
    await api(`${a.url}/api/toggle-github`);
    location.reload();
  }
  </script>
  <template>
    <div id="sheet-overlay" class="sheet-overlay" onclick="closeOptions()"></div>
    <div id="app-sheet" class="bottom-sheet stack p-0">
      <div class="sheet-handle"></div>
      <div class="stack gap-1 p-3">
        <div data-section="gemini" class="stack gap-1">
          <div data-action="chat-existing">
            <button class="menu-item" title="Open Gemini Chat" onclick="window.open(window._CURRENT_APP.chatUrl, '_blank'); closeOptions()">
              Open Gemini Chat
            </button>
          </div>
          <div data-action="chat-missing">
            <div class="text-xs bold text-gray mb-2">Link to Gemini</div>
            <div class="sidebar" style="--side-w: 120px; --gap: 8px;">
              <button class="btn secondary stack gap-1" onclick="const a = window._CURRENT_APP; copyPrompt(a.id, '', a.url, 'Copied Code!');">
                <span class="text-lg bold" style="opacity: 0.2;">1</span>
                <b>Copy Code</b>
              </button>
              <button class="btn secondary stack gap-1" onclick="window.open('https://gemini.google.com', '_blank'); closeOptions()">
                <span class="text-lg bold" style="opacity: 0.2;">2</span>
                <b>Open Gemini</b>
              </button>
            </div>
          </div>
          <div class="border-b my-2"></div>
          <div class="text-xs bold text-gray mb-2">AI Workflow</div>
          <div class="cluster" style="--gap: 8px;">
            <button class="btn secondary stack gap-1" style="flex: 1; min-width: 80px;" title="Copy Build Prompt"
                    onclick="const a = window._CURRENT_APP; copyPrompt(a.id, '', '', 'Copied!'); closeOptions()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
              <b>Prompt</b>
            </button>
            <button class="btn secondary stack gap-1" style="flex: 1; min-width: 80px;" title="Copy Prompt and HTML"
                    onclick="const a = window._CURRENT_APP; copyPrompt(a.id, '', a.url, 'Copied!'); closeOptions()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              <b>Both</b>
            </button>
            <button class="btn secondary stack gap-1" style="flex: 1; min-width: 80px;" title="Copy App HTML"
                    onclick="const a = window._CURRENT_APP; copyHTML(a.url); closeOptions()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
              <b>HTML</b>
            </button>
            {{ if .isadmin }}
              <button class="btn secondary stack gap-1" style="flex: 1; min-width: 80px;" title="Copy Raw HTML" onclick="const a = window._CURRENT_APP; copyRawHTML(a.url); closeOptions()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
                <b>Raw</b>
              </button>
            {{ end }}
          </div>
          <div class="border-b my-2"></div>
        </div>
        <div data-section="github" hidden>
          <a class="menu-item" target="_blank" onclick="closeOptions()">
            New GitHub Issue
          </a>
          <div class="border-b my-2"></div>
        </div>
        <button data-for="owner maintainer" class="menu-item" style="flex: 1;"
                title="Rename Name" onclick="renameAppName(); closeOptions()">
          Change Name
        </button>
        <button data-for="owner maintainer" class="menu-item" style="flex: 1;" title="Rename Slug"
                onclick="renameApp(); closeOptions()">
          Change Domain
        </button>
        <button data-action="invite" data-for="owner maintainer" class="menu-item" title="Copy Invite Link"
                onclick="copyInvite(window._CURRENT_APP.url); closeOptions()">
          Copy Invite Link
        </button>
        <button data-for="owner maintainer" class="menu-item" title="Deploy to GitHub"
                onclick="toggleGitHub(); closeOptions()">
          Deploy to GitHub
        </button>
        <div class="border-b my-2"></div>
        <button data-for="owner maintainer" class="menu-item danger" title="Delete App"
                onclick="const a = window._CURRENT_APP; deleteApp(a.url); closeOptions()">
          Delete App
        </button>
      </div>
    </div>
  </template>
{{ end }}


{{ define "<publish-status-icon>" }}
  <template>
    <div class="relative center" style="display: flex;">
      {{ if .app.IsPublic }}
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 9.9-1"/>
        </svg>
      {{ else }}
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        {{ if .app.Users }}
          <div class="layer rounded-full bg-white" style="position: absolute; top: -2px; right: -4px; width: 8px; height: 8px; background: var(--c-blue); border: 2px solid #fff; z-index: 1;"></div>
        {{ end }}
      {{ end }}
    </div>
  </template>
{{ end }}


{{ define "claim_form" }}
  <layout user="" name={{.Name}} isadmin={{.IsAdmin}}>
    <div class="stack gap-4 p-5 rounded border bg-gray-light text-center m-auto" style="width: min(320px, 100%);">
      {{ if .Claim }}
        {{ if eq .Claim.op "invite" }}Accept invite to {{.Claim.app}}.{{api.Domain}}{{end}}
        {{ if eq .Claim.op "login" }}<p class="text-lg bold">Hello @{{.Claim.user}}</p>{{ end }}
        <form method="post" action="{{ .Path }}" class="stack gap-2">
          <input type="hidden" name="code" value="{{.Code}}">
          <button class="btn primary w-full" title="Enter">Enter</button>
        </form>
      {{ else }}
        <btn-login />
      {{ end }}
    </div>
  </layout>
{{ end }}

{{ define "index" }}
  <layout user={{ .User }} name={{ .Name }} isadmin={{ .isadmin }}>
    {{ if .User }}
      <button class="btn primary p-3 stack center text-center mb-4 w-full shadow-sm"
              onclick="copyPrompt('', '', '', 'Instructions copied! Paste into Gemini.')"
              title="New App">
        <span class="text-sm">Create New App</span>
      </button>
    {{ end }}
    <div id="list" class="stack gap-4" style="width: min(600px, 100%);">
      {{ if .Private }}
        <h3 class="text-xs bold text-gray px-3 section-header">
          Personal (Private)</h3>
        {{ range .Private }}
          <entry-own app={{ . }} />
        {{ end }}
      {{ end }}
      {{ if .Public }}
        <h3 class="text-xs bold text-gray px-3 section-header">
          Personal (Public)</h3>
        {{ range .Public }}
          <entry-own app={{ . }} />
        {{ end }}
      {{ end }}
      {{ if .Maintainer }}
        <h3 class="text-xs bold text-gray px-3 section-header">
          Maintainer</h3>
        {{ range .Maintainer }}
          <entry-maintainer app={{ . }} />
        {{ end }}
      {{ end }}
      {{ if .Community }}
        <h3 class="text-xs bold text-gray px-3 section-header">
          Community</h3>
        {{ range .Community }}
          <entry-shared app={{ . }} />
        {{ end }}
      {{ end }}
    </div>
    {{ if not .User }}
      <div class="mt-4 center">
        <btn-login />
      </div>
    {{ end }}
    <script>
    async function api(url, method = 'POST', body = null) {
      const opts = {method, credentials: 'include'};
      if (body) opts.body = typeof body === 'string' ? body : JSON.stringify(body);
      const r = await fetch(url, opts);
      if (r.status >= 300) {
        const txt = await r.text();
        let msg = `err ${r.status}`;
        try { msg = JSON.parse(txt).err || msg; }
        catch(err) { msg = `${txt.slice(0, 100)}: ${err}` || msg; }
        throw new Error(msg);
      }
      return await r.json();
    }

    const copy = async (txt, msg) => setTimeout(async () => {
      await navigator.clipboard.writeText(txt);
      notify(msg);
    });

    async function copyInvite(url) {
      const v = await api(`${url}/api/invite`);
      await copy(v.result, "Invite link copied!");
    }

    async function copyPrompt(id, name, appURL, msg) {
      const n = name || (!id ? prompt('App Name?') : null);
      if (!id && !n) return;
      const v = await api(`/api/prompt?id=${id||''}&name=${encodeURIComponent(n||'')}`);
      if (!id) { location.reload(); return; }
      let txt = v.result.prompt;
      if (appURL) {
        const r = await fetch(appURL, {credentials: 'include'});
        if (r.ok) txt = (await r.text()) + "\n\n" + txt;
      }
      await copy(txt, msg || "Instructions copied!");
    }

    async function copyHTML(url) {
      const r = await fetch(url, {credentials: 'include'});
      if (!r.ok) throw new Error(r.statusText);
      await copy(await r.text(), "Copied!");
    }

    async function copyRawHTML(url) {
      const r = await fetch(url + "?raw=true", {credentials: "include"});
      if (!r.ok) throw new Error(r.statusText);
      await copy(await r.text(), "Raw HTML copied!");
    }

    async function deleteApp(url) {
      if (!confirm('Delete this app?')) return;
      await api(`${url}/api/delete`);
      location.reload();
    }

    async function togglePublic(url) {
      if (!confirm('Change visibility?')) return;
      await api(`${url}/api/update?toggle-public=true`);
      location.reload();
    }

    async function toggleStatus(url, currentStatus) {
      const warning =
        currentStatus !== 2 ?
        `Ennable Data Protection Mode?
       This prevents the AI from accidentally deleting existing data
       (dropping tables/columns).` :
        `Enable Construction Mode?
       This allows the AI to delete the existing data if needed.`;
      if (!confirm(warning)) return;
      await api(`${url}/api/update?toggle-status=true`);
      location.reload();
    }

    async function remixInto(id, v) {
      const srcSlug = v.includes(".") ? new URL(v.trim()).hostname.split('.')[0] : v.trim();
      notify(`Copying "${srcSlug}"...`);
      await api("/api/remix", "POST", {id, srcSlug});
      location.reload();
    }
    </script>
  </layout>
{{ end }}


{{ define "app-html" }}
  <!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="icon" href="/assets/icon.svg" type="image/svg+xml">
      <link rel="manifest" href="/assets/manifest.json">
      <script>
      window.VAPID_KEY = {{ .VAPIDKey }}
        {{ if .user.ID }}
        localStorage.userAndLevel = "{{.user.ID}}:{{.lvl}}"
        {{ end }}
        window.APP_OWNER = {{ .owner }}
        window.APP_USERS = {{ .users }}
      </script>
    </head>
    {{ if .body }}
      {{ .body }}
    {{ else }}
      not deployed yet...
    {{ end }}
  </html>
{{ end }}
